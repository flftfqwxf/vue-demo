var gift={
          '1':{'title':"昆仑山矿泉水抵用券",
               'desc':"在“昆仑山微店”购买全场任意产品均可抵扣40元现金",
               'logo':"1.png",'price':40,'rules':1},
          '2':{'title':"奇迹健身免费体验卡",
               'desc':"可免费在奇迹健身SM广场店健身体验一次。该礼品为实物卡，下单后2个工作日内客服人员将与您联系确认邮寄地址。",
               'logo':"2.png",'price':128,'rules':0},
          '3':{'title':"阿帕鲁萨小镇餐吧抵用券",
               'desc':"无门槛抵用券，可消费任意食品/酒水时使用。",
               'logo':"3.png",'price':30,'rules':2},
          '4':{'title':"红光马术免费体验券",
               'desc':"可免费在红光国际马术俱乐部享受30分钟马术体验一次。",
               'logo':"4.png",'price':100,'rules':3},
          '5':{'title':"轻安雅集瑜伽免费体验券",
               'desc':"可免费享受瑜伽体验一次（身体评估、肩颈梳理、定制练习方案）。",
               'logo':"5.png",'price':398,'rules':4},
	      '6':{'title':"口腔健康检查免费体验券",
	           'desc':"可免费享受美式口腔健康检查一次（德国进口仪器全景分析、光学数字深度检测）。",
	           'logo':"6.png",'price':320,'rules':3},
	       '7':{'title':"口腔检查+洁牙免费体验券",
	           'desc':"可免费享受美式口腔健康检查+清新亮白洁牙一次。",
	           'logo':"",'price':700,'rules':3}
          };
var proGift={
'31705':[1,3,6], 	
'34366':[1,3,6],	
'29045':[1,3,6],
'34441':[1,3,6],
'29648':[1,3,6],
'29646':[1,3,6],
'29637':[1,3,4,6],
'9370':[1,3,4,6],
'34437':[1,3,4,6],
'34016':[1,3,4,6],
'34432':[1,3,4,6],
'34436':[1,3,4,6],
'29065':[1,3,4,6],
'34535':[1,2,3,4,6],
'34517':[1,2,3,4,6],
'21525':[1,2,3,4,6],
'9192':[1,2,3,4,6],
'33892':[1,2,3,4,6],
'34514':[1,2,3,4,6],
'34460':[1,2,3,4,6],
'21420':[1,2,3,4,6],
'6633':[1,2,3,4,5,6],
'34485':[1,2,3,4,5,6],
'6635':[1,2,3,4,5,6],
'31455':[1,2,3,4,5,6],
'34488':[1,2,3,4,5,6],
'26384':[1,2,3,4,5,6],
'25462':[1,2,3,4,5,6],
'34466':[1,2,3,4,5,6],
'32871':[1,2,3,4,5,6],
'8365':[1,2,3,4,5,6],
'34415':[1,2,3,4,5,6],
'26387':[1,2,3,4,5,6],
'34464':[1,2,3,4,5,6],
'34462':[1,2,3,4,5,6],
'34735':[1,2,3,4,5,6],
'33881':[1,2,3,4,5,6],
'25453':[1,2,3,4,5,6],
'35052':[1,2,3,4,5,6],
'34474':[1,2,3,4,5,6],
'34504':[1,2,3,4,5,6],
'28200':[1,2,3,4,5,6],
'34386':[1,2,3,4,5,6],
'34640':[1,2,3,4,5,6],
'8368':[1,2,3,4,5,6],
'25449':[1,2,3,4,5,6],
'6627':[1,2,3,4,5,6],
'34443':[1,2,3,4,5,6,7],
'35654':[1,2,3,4,5,6,7],
'6630':[1,2,3,4,5,6,7],
'34486':[1,2,3,4,5,6,7], 
'33885':[1,2,3,4,5,6,7],
'32861':[1,2,3,4,5,6,7], 
'34429':[1,2,3,4,5,6,7], 
'31918':[1,2,3,4,5,6,7], 
'34451':[1,2,3,4,5,6,7], 
'34490':[1,2,3,4,5,6,7], 
'28136':[1,2,3,4,5,6,7], 
'34509':[1,2,3,4,5,6,7], 
'34455':[1,2,3,4,5,6,7],
'34499':[1,2,3,4,5,6,7],
'34513':[1,2,3,4,5,6,7], 
'22964':[1,2,3,4,5,6,7], 
'26641':[1,2,3,4,5,6,7], 
'33243':[1,2,3,4,5,6,7], 
'31885':[1,2,3,4,5,6,7], 
'32391':[1,2,3,4,5,6,7], 
'31285':[1,2,3,4,5,6,7], 
'34518':[1,2,3,4,5,6,7], 
'35504':[1,2,3,4,5,6,7], 
'30177':[1,2,3,4,5,6,7], 
'35400':[1,2,3,4,5,6,7], 
'30639':[1,2,3,4,5,6,7],
'33308':[1,2,3,4,5,6,7],
'27979':[1,2,3,4,5,6,7],
'27676':[1,2,3,4,5,6,7],
'32025':[1,2,3,4,5,6,7],
'33928':[1,2,3,4,5,6,7],
'34487':[1,2,3,4,5,6,7],
'34498':[1,2,3,4,5,6,7],
'6341':[1,2,3,4,5,6,7],
'34511':[1,2,3,4,5,6,7],
'34496':[1,2,3,4,5,6,7], 
'34463':[1,2,3,4,5,6,7],
             };


//设置产品的相应礼包            
function setGift(){
  $(".module .module_item").each(function(index, el) {
    var proId= $(this).attr("pro-id");
    var html="",price=0;
    if(proGift[proId] != null){
      for (var i = 0; i < proGift[proId].length; i++) {
        var giftId=proGift[proId][i];
        price+=gift[giftId].price;
      }
      $(this).find(".gift_info").html('<small class="gift_icon"></small>'+price+'元大礼包<span class="gift_view J_info">[详情]</span>');    
      $(this).find(".J_gift").click(function(){
      var giftData={'allPrice':0,'gifts':[]};
        for (var i = 0; i < proGift[proId].length; i++) {
          var giftId=proGift[proId][i];
          giftData.gifts.push(gift[giftId]);
        }
        giftData.allPrice=price;
        $(".gift_detail").remove();
        $(".mask").removeClass("hidden").show();
        window.scrollY=$(window).scrollTop();
        $("body,html").css({"overflow":"hidden","height":"100%"}); 
        $("body").append(template("gift_detail", giftData));
        var h=$(window).height()-110;
        $(".gift_detail").css({"max-height":(h+70)+"px","overflow":"hidden"});
        $(".gift_detail .gift").css({"max-height":h+"px","overflow-y":"auto"});
      });
    }
  });

}
//判断是否是微信端
function isWeiXin(){
    var ua = window.navigator.userAgent.toLowerCase();
    if(ua.match(/MicroMessenger/i) == 'micromessenger'){
        return true;
    }else{
        return false;
    }
}
$(".gift_detail").on('touchmove',function(e){
	e.stopPropagation();
})
var Fclick=true;//防止重复点击领取奖品
//领取奖品
function getGift(){
    var regex= /^0?(13[0-9]|15[0-9]|17[01678]|18[0-9]|14[57])[0-9]{8}$/;
    var phone=$(".input_phone").val(),
    $obj=$("#share_success"),
    actID=$("#actID").val(),
    giftID=parseInt($("#giftID").val()),
    giftData={'userPhone': phone};
    if(giftID!= "" || giftID!="null"){
    	giftData={'userPhone': phone,'giftId':giftID}
    }
    if(!regex.test(phone)){
      $obj.find(".erro").text("请输入正确的手机号！");
      $(".J_getGift").text("立即领取");
    }else{
     $(".J_getGift").text("领取中...");
     $obj.find(".erro").text("");
     $.ajax({
           url: '/activity/'+actID+'/gift',
           type: 'POST',
           dataType: 'json',
           data:giftData ,
         })
         .done(function(result) {
        	if(result.errMsg){
                $obj.find(".erro").text(result.errMsg);
        	}else{
	            $("#share_success").addClass('hidden').hide();
	            $("#get_success").removeClass('hidden').show(300);
        	}
            $(".J_getGift").text("立即领取");
            Fclick=true;
         })
         .fail(function() {
             $(".J_getGift").text("领取失败，请重试");
         });
    }
}
//关闭领取礼包
function colseShare(){
	 $('.share_div').removeClass("hidden").hide();
	 $("#get_success").removeClass("hidden").hide();
	 $("#share_success").show();
	 $(".mask").removeClass("hidden").hide();
}
(function(){
    //为产品设置礼包
    setGift();
    //关闭礼包详情
    $('body').on("click",".gift_detail .J_close",function(){
       $(".gift_detail").remove();
       $(".mask").removeClass("hidden").hide();
         $("body,html").css({"overflow-y":"auto","height":"auto"});
         $(window).scrollTop(window.scrollY);
         
     });
    
   
   //点击见面礼的礼包详情
   $(".J_meet").click(function(){
      var giftData={'allPrice':gift['1'].price,'gifts':[gift['1']]};
      $(".gift_detail").remove();
      $(".mask").removeClass("hidden").show();
       window.scrollY=$(window).scrollTop();
      $("body,html").css({"overflow":"hidden","height":"100%"});
      $("body").append(template("gift_detail", giftData));
      var h=$(window).height()-110;
      $(".gift_detail .gift").css({"max-height":h+"px"});
   });

   $("body").on("input",".input_phone",function(){
	   Fclick=true;
   });
   //点击领取见面礼
   $("header").on("click",".J_giftBtn",function(){
      if(isWeiXin()){
          checkSuccess=true;
          $(".share_tips").removeClass("hidden").show();
          $(".returnTop").hide();
          wx.ready(function () {
              weixinShareSDK.webWeiXinShare(title,imgUrl,content,checkSuccess);
          });
      }else{
          alert('在微信中访问本页面才能抽奖哦！');
      }
   });

   //输入电话号码领取奖品
   $("#weiXinSuccess").on("click",".J_getGift",function(){
	    if(Fclick){
	      Fclick=false;
		   getGift();
        }else{
        	return;
    	}
   });

  $("#weiXinSuccess").on('click', '.J_goPro', function(event) {
    $("#weiXinSuccess,#get_success").addClass("hidden").hide();
    $("#share_success").removeClass("hidden").show();
    $(".mask").removeClass('hidden').hide();
  });
  //点击微信提示，微信提示消失       
   $(".share_tips").click(function() {
     $(this).hide();
   });

 })();